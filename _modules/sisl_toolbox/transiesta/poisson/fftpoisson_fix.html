<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sisl_toolbox.transiesta.poisson.fftpoisson_fix &mdash; sisl 0.1-b0feb0c</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/tabs.css?v=4c969af8" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery.css?v=61a4c737" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=87e54e7c" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom_styles.css?v=cafe85c1" />
      <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=81cd38e2"></script>
        <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../../_static/copybutton.js?v=f281be69"></script>
        <script src="../../../../_static/tabs.js?v=3ee01567"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../../../_static/togglebutton.js?v=4a39c7ea"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            sisl
          </a>
              <div class="version">
                0.1-b0feb0c
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../scripts/index.html">Command line scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../environment.html">Environment variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../math.html">Mathematical notation convention</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Visualization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../visualization/viz_module/index.html"><code class="docutils literal notranslate"><span class="pre">sisl.viz</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../visualization/ase/index.html">ASE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Toolboxes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../toolbox/index.html">Toolboxes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development details</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contribute.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cite.html">Citing sisl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../other.html">Similar solutions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../references.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">sisl</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">sisl_toolbox.transiesta.poisson.fftpoisson_fix</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sisl_toolbox.transiesta.poisson.fftpoisson_fix</h1><div class="highlight"><pre>
<span></span><span class="c1"># This Source Code Form is subject to the terms of the Mozilla Public</span>
<span class="c1"># License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<span class="c1"># file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="sa">r</span><span class="sd">&quot;&quot;&quot; Hartree correction for FFT-Poisson solver for arbitrary electrode positions</span>

<span class="sd">Developer: Nick Papior</span>
<span class="sd">Contact: nickpapior &lt;at&gt; gmail.com</span>
<span class="sd">sisl-version: &gt;=0.9.3</span>

<span class="sd">This Poisson solver uses pyamg to calculate an initial guess for the Poisson</span>
<span class="sd">solution to correct the FFT solution. It does this by setting up boundary</span>
<span class="sd">conditions on electrodes and then solving the Hartree potential using multi-grid</span>
<span class="sd">solvers.</span>

<span class="sd">It requires two inputs and has several optional flags.</span>

<span class="sd">- The siesta.TBT.nc file which contains the geometry that is to be calculated for</span>
<span class="sd">  The reason for using the siesta.TBT.nc file is the ease of use:</span>

<span class="sd">    The siesta.TBT.nc contains electrode atoms and device atoms. Hence it</span>
<span class="sd">    becomes easy to read in the electrode atomic positions.</span>
<span class="sd">    Note that since you&#39;ll always do a 0 V calculation it is easy to</span>
<span class="sd">    do a 0 bias calculation first, then create a guess using this script,</span>
<span class="sd">    and finally do bias calculations.</span>

<span class="sd">- The grid size of the simulation grid, this needs to be commensurate with the</span>
<span class="sd">  actual Siesta grid used.</span>

<span class="sd">This script is a command-line utility with several options (please refer to</span>
<span class="sd">--help). There are a few important flags you should know about:</span>

<span class="sd">  --tolerance [tol] specify the tolerance of the solution, the tighter the longer solution time</span>
<span class="sd">  --shape-solver [nx ny nz] shape for which the solution is calculated (impacts speed)</span>
<span class="sd">  --shape [nx ny nz] final shape of the solution, if shape-solver is not the same the solution will be interpolated (order=2)</span>
<span class="sd">  --dtype [f|d] the data-type used to solve the Poisson equation</span>
<span class="sd">  --out [file] any sisl compatible grid file, please at least do --out V.TSV.nc which is compatible with TranSiesta.</span>

<span class="sd">This tool requires the following packages:</span>
<span class="sd">- pyamg</span>

<span class="sd">Known problems:</span>
<span class="sd">- The pyamg solver requires quite a bit of memory, you should preferentially select</span>
<span class="sd">  the largest grid (up to the actual grid size you want) possible.</span>
<span class="sd">- The Neumann implementation in the boundary conditions is not correct, hence</span>
<span class="sd">  it may never converge (or produce nan&#39;s). If this happens please try another</span>
<span class="sd">  boundary condition.</span>
<span class="sd">- It may not always converge which requires some fine-tuning of the tolerances,</span>
<span class="sd">  secondly it may converge too fast so the solution is not really good.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">argparse</span> <span class="k">as</span> <span class="nn">argp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">sisl</span> <span class="k">as</span> <span class="nn">si</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pyamg_solve&quot;</span><span class="p">,</span> <span class="s2">&quot;solve_poisson&quot;</span><span class="p">,</span> <span class="s2">&quot;fftpoisson_fix_cli&quot;</span><span class="p">,</span> <span class="s2">&quot;fftpoisson_fix_run&quot;</span><span class="p">]</span>


<span class="n">_BC</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">BoundaryCondition</span>

<span class="c1"># Base-script name</span>
<span class="n">_script</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">name</span>

<span class="n">_DEBUG</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SISL_TS_FFT_DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">)</span>
<span class="c1"># Determine from env-var whether we should use debug mode</span>
<span class="n">_DEBUG</span> <span class="o">=</span> <span class="n">_DEBUG</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pyamg_solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">accel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">pyamg</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Setting up pyamg solver... </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ml</span> <span class="o">=</span> <span class="n">pyamg</span><span class="o">.</span><span class="n">aggregation</span><span class="o">.</span><span class="n">smoothed_aggregation_solver</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">max_levels</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">A</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ml</span><span class="p">)</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="c1"># residuals calculated in the solve function is a pre-conditioned residual</span>
        <span class="c1"># residuals.append(np.linalg.norm(b - A.dot(x)) ** 0.5)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;    </span><span class="si">{:4d}</span><span class="s2">  residual = </span><span class="si">{:.5e}</span><span class="s2">   x0-residual = </span><span class="si">{:.5e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">residuals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">residuals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">residuals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
        <span class="n">b</span><span class="p">,</span>
        <span class="n">tol</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
        <span class="n">residuals</span><span class="o">=</span><span class="n">residuals</span><span class="p">,</span>
        <span class="n">accel</span><span class="o">=</span><span class="n">accel</span><span class="p">,</span>
        <span class="n">cycle</span><span class="o">=</span><span class="s2">&quot;W&quot;</span><span class="p">,</span>
        <span class="n">maxiter</span><span class="o">=</span><span class="mf">1e7</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done solving the Poisson equation!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>


<div class="viewcode-block" id="solve_poisson">
<a class="viewcode-back" href="../../../../toolbox/generated/sisl_toolbox.transiesta.poisson.solve_poisson.html#sisl_toolbox.transiesta.poisson.solve_poisson">[docs]</a>
<span class="k">def</span> <span class="nf">solve_poisson</span><span class="p">(</span>
    <span class="n">geometry</span><span class="p">,</span>
    <span class="n">shape</span><span class="p">,</span>
    <span class="n">radius</span><span class="o">=</span><span class="s2">&quot;empirical&quot;</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
    <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
    <span class="n">accel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">boundary_fft</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">device_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_boundary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">box</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">elecs_V</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve Poisson equation&quot;&quot;&quot;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">elecs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">geometry</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;+&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Buffer&quot;</span><span class="p">,</span> <span class="s2">&quot;Device&quot;</span><span class="p">]):</span>
            <span class="k">continue</span>

        <span class="c1"># This is actually an electrode</span>
        <span class="n">elecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">error</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">elecs_V</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elecs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_script</span><span class="si">}</span><span class="s2">: Could not find any electrodes in the geometry.&quot;</span><span class="p">)</span>

    <span class="n">error</span> <span class="o">=</span> <span class="n">error</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">elecs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elecs_V</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">elecs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">elecs_V</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; missing electrode bias: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_script</span><span class="si">}</span><span class="s2">: Missing electrode arguments for specifying the bias.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="p">[[</span><span class="n">_BC</span><span class="o">.</span><span class="n">PERIODIC</span><span class="p">,</span> <span class="n">_BC</span><span class="o">.</span><span class="n">PERIODIC</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">bc2bc</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;periodic&quot;</span><span class="p">:</span> <span class="s2">&quot;PERIODIC&quot;</span><span class="p">,</span>
                <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="s2">&quot;PERIODIC&quot;</span><span class="p">,</span>
                <span class="n">_BC</span><span class="o">.</span><span class="n">PERIODIC</span><span class="p">:</span> <span class="s2">&quot;PERIODIC&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dirichlet&quot;</span><span class="p">:</span> <span class="s2">&quot;DIRICHLET&quot;</span><span class="p">,</span>
                <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="s2">&quot;DIRICHLET&quot;</span><span class="p">,</span>
                <span class="n">_BC</span><span class="o">.</span><span class="n">DIRICHLET</span><span class="p">:</span> <span class="s2">&quot;DIRICHLET&quot;</span><span class="p">,</span>
                <span class="s2">&quot;neumann&quot;</span><span class="p">:</span> <span class="s2">&quot;NEUMANN&quot;</span><span class="p">,</span>
                <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="s2">&quot;NEUMANN&quot;</span><span class="p">,</span>
                <span class="n">_BC</span><span class="o">.</span><span class="n">NEUMANN</span><span class="p">:</span> <span class="s2">&quot;NEUMANN&quot;</span><span class="p">,</span>
            <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span> <span class="ow">in</span> <span class="n">boundary</span><span class="p">:</span>
            <span class="n">bc</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">_BC</span><span class="p">,</span> <span class="n">bc2bc</span><span class="p">(</span><span class="n">bottom</span><span class="p">)),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_BC</span><span class="p">,</span> <span class="n">bc2bc</span><span class="p">(</span><span class="n">top</span><span class="p">))])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_script</span><span class="si">}</span><span class="s2">: Requires a 3x2 list input for the boundary conditions.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_shape_tree</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes two lists A and B which returns a shape with a binary nesting</span>

<span class="sd">        This makes further index handling much faster.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">B</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_create_shape_tree</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">AA</span><span class="p">,</span> <span class="n">BB</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">AA</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">Sphere</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">xyz</span><span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AA</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">BB</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">Sphere</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">xyz</span><span class="p">[</span><span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">BB</span>

        <span class="c1"># Quick return if these are the final ones</span>
        <span class="k">if</span> <span class="n">AA</span> <span class="ow">and</span> <span class="n">BB</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AA</span> <span class="o">|</span> <span class="n">BB</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">AA</span><span class="p">:</span>
            <span class="n">AA</span> <span class="o">=</span> <span class="n">_create_shape_tree</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">BB</span><span class="p">:</span>
            <span class="n">BB</span> <span class="o">=</span> <span class="n">_create_shape_tree</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">AA</span> <span class="o">|</span> <span class="n">BB</span>

    <span class="c1"># Create grid and specify boundary conditions</span>
    <span class="n">geometry</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">set_boundary_condition</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">Grid</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">_fake</span><span class="p">:</span>
        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">shape</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dtype</span>

    <span class="c1"># Fake the grid to reduce memory requirement</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">_fake</span><span class="p">()</span>

    <span class="c1"># Construct matrices we need to specify the boundary conditions on</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">pyamg</span><span class="p">()</span>

    <span class="c1"># Short-hand notation</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">xyz</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">device_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Applying device potential = </span><span class="si">{</span><span class="n">device_val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="s2">&quot;Device&quot;</span><span class="p">]</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">_create_shape_tree</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">index_truncate</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">pyamg_index</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">pyamg_fix</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">device_val</span><span class="p">)</span>

    <span class="c1"># Apply electrode constants</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Applying electrode potentials&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elecs</span><span class="p">):</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">elecs_V</span><span class="p">[</span><span class="n">elec</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">elec</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">V</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">elec</span><span class="p">]</span>
        <span class="n">elec_shape</span> <span class="o">=</span> <span class="n">_create_shape_tree</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">index_truncate</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">elec_shape</span><span class="p">))</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">pyamg_index</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">pyamg_fix</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">idx</span><span class="p">,</span> <span class="n">elec_shape</span>

    <span class="c1"># Now we have initialized both A and b with correct boundary conditions</span>
    <span class="c1"># Lets solve the Poisson equation!</span>
    <span class="k">if</span> <span class="n">box</span><span class="p">:</span>
        <span class="c1"># No point in solving the boundary problem if requesting a box</span>
        <span class="n">boundary_fft</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">A</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pyamg_solve</span><span class="p">(</span>
            <span class="n">A</span><span class="p">,</span>
            <span class="n">b</span><span class="p">,</span>
            <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span>
            <span class="n">accel</span><span class="o">=</span><span class="n">accel</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;solving electrode boundary conditions&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span>

    <span class="k">if</span> <span class="n">boundary_fft</span><span class="p">:</span>
        <span class="c1"># Change boundaries to always use dirichlet</span>
        <span class="c1"># This ensures that once we set the boundaries we don&#39;t</span>
        <span class="c1"># get any side-effects</span>
        <span class="n">BC</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">BoundaryCondition</span>
        <span class="n">periodic</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">bc</span> <span class="o">==</span> <span class="n">BC</span><span class="o">.</span><span class="n">PERIODIC</span> <span class="ow">or</span> <span class="n">geometry</span><span class="o">.</span><span class="n">nsc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">boundary_condition</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">BC</span><span class="o">.</span><span class="n">DIRICHLET</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">periodic</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">bc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">BC</span><span class="o">.</span><span class="n">PERIODIC</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">set_boundary_condition</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">pyamg</span><span class="p">()</span>

        <span class="c1"># Solve only for the boundary fixed</span>
        <span class="k">def</span> <span class="nf">sl2idx</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">sl</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">grid</span><span class="o">.</span><span class="n">pyamg_index</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">mgrid</span><span class="p">(</span><span class="n">sl</span><span class="p">))</span>

        <span class="c1"># Create slices</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>

        <span class="c1"># One boundary at a time</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">periodic</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">new_sl</span> <span class="o">=</span> <span class="n">sl</span><span class="p">[:]</span>
            <span class="n">new_sl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">sl2idx</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">new_sl</span><span class="p">)</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">pyamg_fix</span><span class="p">(</span>
                <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">new_sl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_sl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_sl</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">new_sl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">sl2idx</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">new_sl</span><span class="p">)</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">pyamg_fix</span><span class="p">(</span>
                <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">new_sl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_sl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_sl</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_boundary</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="c1"># now plot every plane</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

            <span class="n">slicex3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">index_exp</span><span class="p">[:]</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">length</span><span class="p">[</span><span class="n">ax</span><span class="p">],</span> <span class="n">shape</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">slicex3</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

                <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">head</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">)):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;axis: </span><span class="si">{</span><span class="s1">&#39;ABC&#39;</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">head</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="n">idx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dat</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance along </span><span class="si">{</span><span class="s1">&#39;ABC&#39;</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> [Ang]&quot;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance along </span><span class="si">{</span><span class="s1">&#39;ABC&#39;</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2"> [Ang]&quot;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">grid</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">_fake</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pyamg_solve</span><span class="p">(</span>
            <span class="n">A</span><span class="p">,</span>
            <span class="n">b</span><span class="p">,</span>
            <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span>
            <span class="n">accel</span><span class="o">=</span><span class="n">accel</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;removing electrode boundaries and solving for edge fixing&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">grid</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span>

    <span class="k">return</span> <span class="n">grid</span></div>



<span class="k">def</span> <span class="nf">fftpoisson_fix_cli</span><span class="p">(</span><span class="n">subp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">is_sub</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">subp</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;FFT Poisson corrections for TranSiesta calculations for arbitrary number of electrodes.&quot;</span>
    <span class="k">if</span> <span class="n">is_sub</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">_script</span>
        <span class="n">_script</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_script</span><span class="si">}</span><span class="s2"> ts-fft&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;ts-fft&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">argp</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">tuning</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="s2">&quot;tuning&quot;</span><span class="p">,</span> <span class="s2">&quot;Tuning fine details of the Poisson calculation.&quot;</span>
    <span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--geometry&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-G&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta.TBT.nc&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;FILE&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;siesta.TBT.nc file which contains the geometry and electrode information, currently we cannot read that from fdf-files.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--shape&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Grid shape, this *has* to be conforming to the TranSiesta calculation, read from output: &#39;InitMesh: MESH = A x B x C&#39;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="s2">&quot;second&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;third&quot;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="s2">&quot;abc&quot;</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;--boundary-condition-</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;-bc-</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">],</span>
            <span class="n">metavar</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;BOTTOM&quot;</span><span class="p">,</span> <span class="s2">&quot;TOP&quot;</span><span class="p">),</span>
            <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Boundary condition along the </span><span class="si">{}</span><span class="s2"> lattice vector [periodic/p, neumann/n, dirichlet/d]. &quot;</span>
                <span class="s2">&quot;Specify separate BC at the start and end of the lattice vector, respectively.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">n</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--elec-V&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-V&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify chemical potential on electrode&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--shape-solver&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-ss&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--pyamg-shape&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-ps&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Grid used to solve the Poisson equation, if shape is different the Grid will be interpolated (order=2) after.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--device&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-D&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;VAL&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Fix the value of all device atoms to a value. In some cases this turns out to yield a better box boundary. The default is to *not* fix the potential on the device atoms.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">tuning</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--radius&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-R&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;R&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Radius of atoms when figuring out the electrode sizes, this corresponds to the extend of &quot;</span>
            <span class="s2">&quot;each electrode where boundary conditions are fixed. Should be tuned according to the atomic species [3 Ang]&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">tuning</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--dtype&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-d&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;f64&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;f32&quot;</span><span class="p">],</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Precision of data (d/f64==double, f/f32==single)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">tuning</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--tolerance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-T&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;EPS&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Precision required for the pyamg solver. NOTE when using single precision arrays this should probably be on the order of 1e-5&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">tuning</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--acceleration&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-A&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;accel&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;cg&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;METHOD&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Acceleration method for pyamg. May be useful if it fails to converge</span>

<span class="s2">Try one of: cg, gmres, fgmres, cr, cgnr, cgne, bicgstab, steepest_descent, minimal_residual&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">test</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="s2">&quot;testing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Options used for testing output. None of these options should be used for production runs!&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">test</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--box&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Only store the initial box solution (i.e. do not run PyAMG)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">test</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-boundary-fft&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;boundary_fft&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable the 2nd solution with the boundaries fixed. Generally, this solver will first solve for the electrode boundary conditions, then for the fixed box boundary conditains (gotten from the first solution).&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">_DEBUG</span><span class="p">:</span>
        <span class="n">test</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--plot&quot;</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;plot&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Plot grid by averaging over the axis given as argument&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">test</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--plot-boundary&quot;</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;plot_boundary&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Plot all 6 edges of the box with their fixed values (just before 2nd pyamg solve step)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--out&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output file to store the resulting Poisson solution. It *has* to have TSV.nc file ending to make the file conforming with TranSiesta.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">is_sub</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="n">fftpoisson_fix_run</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fftpoisson_fix_run</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parse_args</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">fftpoisson_fix_run</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&gt;</span><span class="se">\n</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">_script</span><span class="si">}</span><span class="s2">: No out-files has been specified, work will be carried out but not saved!</span><span class="se">\n</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Read in geometry</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">get_sile</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">()</span>

    <span class="c1"># Figure out the electrodes</span>
    <span class="n">elecs_V</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">elec_V</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_script</span><span class="si">}</span><span class="s2">: Please specify all electrode potentials using --elec-V&quot;</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">V</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">elec_V</span><span class="p">:</span>
        <span class="n">elecs_V</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;f32&quot;</span><span class="p">):</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;f64&quot;</span><span class="p">):</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>

    <span class="c1"># Now we can solve Poisson</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">shape_solver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">shape_solver</span>

    <span class="c1"># Create the boundary conditions</span>
    <span class="n">boundary</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">boundary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">boundary_condition_a</span><span class="p">)</span>
    <span class="n">boundary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">boundary_condition_b</span><span class="p">)</span>
    <span class="n">boundary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">boundary_condition_c</span><span class="p">)</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">solve_poisson</span><span class="p">(</span>
        <span class="n">geometry</span><span class="p">,</span>
        <span class="n">shape</span><span class="p">,</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
        <span class="n">boundary</span><span class="o">=</span><span class="n">boundary</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">tolerance</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tolerance</span><span class="p">,</span>
        <span class="n">box</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">box</span><span class="p">,</span>
        <span class="n">accel</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">accel</span><span class="p">,</span>
        <span class="n">boundary_fft</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">boundary_fft</span><span class="p">,</span>
        <span class="n">device_val</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="n">plot_boundary</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">plot_boundary</span><span class="p">,</span>
        <span class="o">**</span><span class="n">elecs_V</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">_DEBUG</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">plot</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

            <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">length</span><span class="p">[</span><span class="n">ax</span><span class="p">],</span> <span class="n">shape</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

            <span class="c1"># Now plot data</span>
            <span class="k">del</span> <span class="n">axs</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">plot</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">idx</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">plot</span><span class="p">]</span>

            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">axs</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">grid</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Averaged over </span><span class="si">{</span><span class="s1">&#39;ABC&#39;</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">plot</span><span class="p">]</span><span class="si">}</span><span class="s2"> axis&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance along </span><span class="si">{</span><span class="s1">&#39;ABC&#39;</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s2"> [Ang]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance along </span><span class="si">{</span><span class="s1">&#39;ABC&#39;</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="si">}</span><span class="s2"> [Ang]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Interpolating the solution...&quot;</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done interpolating!&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="c1"># Write solution to the output</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">out</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing to file: </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">V</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="c1"># Import object holding all the CLI</span>
<span class="kn">from</span> <span class="nn">sisl_toolbox.cli</span> <span class="kn">import</span> <span class="n">register_toolbox_cli</span>

<span class="n">register_toolbox_cli</span><span class="p">(</span><span class="n">fftpoisson_fix_cli</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">fftpoisson_fix_cli</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015-2024, Nick Papior.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>